---
title: "Bayesian analysis of EXCEL results - Figure 1"
author: "J Brophy"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    highlight: tango
    theme: cerulean
    toc: yes
    toc_float: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Fundamental

## Version and setting

First for all
```{r}
sessionInfo()
```

è¨­ç½®æˆ UTF-8
- Tools > Global Options > Code > Saving > Default text encoding > UTF-8


## Rstudio environment

- Four panels
  + Script
  + Console
  + Environment, History, Connections, Tuttorial
  + Files, Plots, Packages, Help, Viewer
- R project
- Rmd
  + Reference: https://rmarkdown.rstudio.com/lesson-1.html
  + Knit
  + Code chunk: (Mac) command+option+i / (Win) ctrl+alt+i

## Data structure

Vector
- Atomic vector
  + Logical
  + Integer (factor, date) \in numeric(number)
  + Double (time) \in numeric(number)
  + Character
  + (vector, matrix, array)
- List (data.frame, tibble)

command+option+i / cntl+alt+i

### Atomic vector

#### logical/integer/double/character vector
```{r}
a = c(1L, 2L, 3L) #integer
a
typeof(a)
mode(a)

d = c(3.3, 3.14) # double
d
typeof(d) # vvvv
mode(d) # xxxx

b = c("ha", "you", "hello") #charcter
b
typeof(b)

e = c(TRUE, FALSE, T, F)
e
typeof(e)
```

#### matrix / array
```{r}

1:8
c(1, 2, 3, 4, 5,6,7,8)
aMatrix <- matrix(1:8, ncol = 2, byrow = TRUE)
aMatrix

aArray <- array(1:8, dim = c(2,2,2))
aArray
```


#### subvector
```{r}
d <- c(23, 2.5, 3.8, 9)
d
typeof(d)

sum(d)
sd(d)
max(d)
min(d)
summary(d)

d[2]
d[3]

d[c(1, 3)]

aMatrix[2, 1]
aMatrix[1, ]
aMatrix[, 1]
aMatrix[c(2,3), c(1,2)]
aMatrix[6]
aMatrix

```

### List

#### list
```{r}
l = list(3, 3.4, "a", TRUE)
l
typeof(l)

aList = list(a = 1:3, # a = c(1,2,3)
             b = TRUE, 
             c = list(d = "happy", 
                      e = c(1.3, 4.5, 7.83, pi)))
aList

typeof(aList)
class(aList)
```

#### sublist??
```{r}
aList
aList[1]
aList["a"]
aList$a
aList[[1]]
aList[["a"]]

aList$c
aList$c[2]
aList$c[[2]]
aList$c[2][2]
aList$c[[2]][2]
aList$c$e
aList$c$e[2]

aList[3]
aList[[3]]
aList[[3]][2]
#...
```

#### data.frame (2-dim)

- row: observation
- col: variable
```{r}
rep(1.5, times = 6)
rev(11:16)
aDf <- data.frame(a = rep(1.5, times = 6),
                  b = c("a", "b", "c", "d", "e", "f"),
                  c = LETTERS[1:6],
                  d = c(TRUE, FALSE, TRUE, FALSE, T, F),
                  e = rev(11:16))
aDf
typeof(aDf)
class(aDf)
class(aList)


```
#### sub-data.frame
```{r}
# [] 
aDf[1]
aDf["a"]

# [,]
aDf[1, 3]
aDf[c(1, 3), 3:4]

# [[]]
aDf[[3]]
aDf[["c"]]
aDf[[3]][3]

# $
aDf$e
aDf$e[2:3]
```

## How to use help

```{r}
d
sum(d)
help(sum)
# ?sum
# ??sum
```



--------------------------------------------------------------------------------
## 0628_Exercises

1. å¦‚æœæœ‰ç©ºçš„è©±å¯ä»¥çœ‹ä¸€çœ‹ Rmarkdown çš„ä»‹ç´¹ [https://rmarkdown.rstudio.com/lesson-1.html]ï¼Œæˆ–æ˜¯ç›´æ¥ä¸Šç¶²æœå°‹ Rmarkdown çš„å…¶ä»–æ•™å­¸ã€‚
  
  - ä½ å¯ä»¥å˜—è©¦ knit é€™ä»½æ–‡ä»¶çœ‹çœ‹ï¼Ÿï¼æ˜¯å¦æœ‰æˆåŠŸï¼Ÿ

2. ç†è§£ä¸Šæ–¹æ¯ä¸€æ¢ code çš„èªæ³•èˆ‡çµæœæ˜¯ä»€éº¼
  
  - å¯ä»¥å˜—è©¦æ›´æ”¹è£¡é ­çš„å…ƒç´ ï¼Œå¦‚`[1]`æ”¹æˆ`[2]`
  - ç”¨ `help()` æŸ¥è©¢æ¯å€‹ function, å¦‚ `help(c)`, `help(sum)`, `help(help)`
  - ä½ èƒ½ä¸èƒ½å»ºç«‹å±¬æ–¼è‡ªå·±çš„ä¾‹å­
  
3. è§€å¯Ÿ atomic vector èˆ‡ list è®Šæ•¸è·‘å‡ºä¾†å‘ˆç¾ä¸Šçš„å·®ç•°ã€‚

4. åœ¨ sub-list èˆ‡ sub-data.frame çš„ code chunk ä¸­ï¼Œåˆ†åˆ¥ç”¨äº† `[`ã€`[[` é‚„æœ‰ 
`$` é€™ä¸‰ç¨®å¥‡æ€ªçš„ç¬¦è™Ÿ
  
  - è«‹ä½ ä»”ç´°è§€å¯Ÿé€™ä¸‰å€‹ç¬¦è™Ÿä½¿ç”¨ä¸Šçš„å·®ç•°ï¼Œä¸¦åœ¨ä¸‹æ¬¡ä¸Šèª²æ™‚å‘Šæ•¸æˆ‘ä½ ç™¼ç¾åˆ°ä»€éº¼ã€‚
  - å»ºè­°å¯ä»¥æ­é… `typeof()` è§€å¯Ÿï¼Œä¾‹å¦‚ `typeof(aList[[3]])`ã€‚
 
5. [é¡å¤–è£œå……] [è¼•é¬†å­¸ç¿’Rèªè¨€](https://yaojenkuo.gitbooks.io/learn-r-the-easy-way/content/chapter2.html)ï¼Œå¯ä»¥åƒè€ƒè£¡é ­çš„ Day2-Day7
  
  - é€™å¹¾ç« å‰›å¥½æœ‰æåˆ° R å…¶ä»–ç¨®é¡çš„è³‡æ–™å‹æ…‹ (type of) ä»¥åŠè³‡æ–™çµæ§‹ (structure) æˆ–æ­£ç¢ºä¾†èªªæ˜¯å±¬æ€§ (class)
  - é›–ç„¶ä»–æ˜¯å¯«å¾—æ·ºé¡¯æ˜“æ‡‚ (è€Œä¸”æ˜¯ä¸­æ–‡)ï¼Œä½†å¯¦éš›ä¸Šä»–å°‡è³‡æ–™çµæ§‹ç”¨ç¶­åº¦çš„æ–¹å¼ä¾†é€²è¡Œåˆ†é¡ï¼Œæˆ‘ä¸å®Œå…¨åŒæ„é€™ç¨®æ–¹å¼(ä½†å¤§éƒ¨ä»½ R èªè¨€ä»‹ç´¹æ›¸éƒ½æ˜¯è€…æ¨£å¯«)ï¼Œå› ç‚ºå®ƒä¸¦æ²’æœ‰æŠŠ atomic vector èˆ‡ list åšå‡ºæ˜é¡¯çš„å€åˆ†ã€‚
  - æœ€æ­£ç¢ºçš„åˆ†é¡æ–¹å¼ï¼š[Advance R: Chapter 3](https://adv-r.hadley.nz/vectors-chap.html)
  - é †å¸¶ä¸€é¡Œ,ä¸Šé¢å…©æœ¬æ›¸å¯¦éš›ä¸Šéƒ½æ˜¯ç”± Rmarkdown å¯«çš„å–”ï¼ï¼ï¼
  
6. å¦‚æœä½ è¦ºå¾—æˆ‘ä¸Šèª²æœ‰ä»»ä½•å»ºè­°ï¼Œè¬›å¤ªç°¡å–®ã€å¤ªé›£ã€å¤ªæ…¢ã€å¤ªå¿«ç­‰ï¼Œéƒ½å¾ˆæ­¡è¿ç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å€‘å¯ä»¥æŒçºŒæ”¹é€²æ‰¾åˆ°å½¼æ­¤é©åˆçš„æ¨¡å¼ ğŸ˜
--------------------------------------------------------------------------------


### assignment, replacment
```{r}
a1 = c(10, 11, 12)
a2 <- c(10, 11, 12)
a4 <- c(10, 20, 30) -> a3

a1
a2
a3
a4

a1 == a2
a2 == a3
a3 == a1

identical(a1, a2)
identical(a1, a3)
```


```{r}
a1[2]
a1[2:3]

a1[c(3, 1)]

a1
a1[c(3, 1)] <- c(100, 300)
a1

a1
a3
a1[c(3, 1)] <- a3[c(2, 3)]
a1

a3
a3 <- rev(a3)
a3
```
```{r}
aVector <- c(a = 1, b = 2, c = 3)
aVector
names(aVector)
names(aVector) <- c("q", "w", "e")
aVector

aVector["a"]
aVector[["a"]]

largerThanTwo <- aVector >= 2
largerThanTwo
aVector[largerThanTwo]
aVector[c(2, 3)]
aVector[c(F, T, T)]
```
```{r}
sum(a1)
sd(a1)
mean(a1)
Mode(a1) ## mode(a1)
median(a1)
max(a1)
```


## Enter data

Enter data according to these variable names   
  
Mc = totality mortality in control (CABG) arm    
Me = totality mortality in experimental (PCI) arm    
Pc = Death, MI, stroke  in control (CABG) arm     
Pe = Death, MI, stroke in experimental (PCI) arm     
Re = MACCE outcome in experimental (PCI) arm (Death, MI, stroke, revascularization)         
Rc = MACCE outcome in control (CABG) arm (Death, MI, stroke, revascularization)          
Nc = Number of subjects in control (CABG) arm    
Ne = Number of subjects in experimental (PCI) arm     

$$
posterior = \frac{prior \times likelihood}{constant} \\
\sum_{i = 1}^n i = \frac{n\times(n+1)}{2}
$$

## package
functions and dataset

dataset
```{r}
iris
mtcars
help(mtcars)
data()

data(package = "CCTpack")
```


```{r results='asis', warning=FALSE, message=FALSE}
# install.packages("")
# indtall.packages(c("", ""))

library(knitr) #kable()
#library(coda)
#library(rjags) 
library(kableExtra)
#library(ggplot2)
library(ggthemes)
library(metafor)
library(meta)
library(tidyverse)

# require(tidyverse)
```



```{r results='asis', warning=FALSE, message=FALSE}
# mortality data entered as NOBLE, SYNTAX,  EXCEL, PRECOMBAT (leave oout these small trials Boudriot) 
# composite endpoint for Noble = sum mortality+Mi+stroke PCI= 54+43+21=118; CABG=50+15+12=77
Mc<-c(23, 50, 48, 89) #event in non-expose (CABG)
Nc<-c(300, 592, 348, 957) #total in non-expose
Me<-c(17, 54, 45, 119) #event in expose (PCI)
Ne<-c(300, 592, 357, 948) #total in expose
Pc<-c(28, 77, 69, 176) #event in non-expose (CABG)
Pe<-c(25, 118, 67, 203) #event in expose (PCI)
Re <- c(52, 165,130,290) #event in expose (PCI) - MACCE includes revasc
Rc <- c(42, 110, 103, 228) #event in non-expose (CABG) - MACCE includes revasc

temp <- data.frame(Mc=Mc,Me=Me,Pc=Pc, Pe=Pe, Rc=Rc, Re=Re, Nc=Nc, Ne=Ne)
temp

tem2 <- data.frame(Mc = c(23, 50, 48, 89),
                   Nc = c(300, 592, 348, 957))

temp
temp[, 3]
temp$Pc

temp[3]
temp["Pc"]

temp$Pc <- temp$Pc * 2 

temp$Study <- c("PRECOMBAT", "NOBLE", "SYNTAX", "EXCEL")
temp

t1 <- temp[9]
t1
t2 <- temp[1:8]
t2
temp2 <- cbind(t1, t2)
temp2
temp
temp3 <- rbind(temp, temp)
temp3

temp <- temp[c(9,1:8)] # reorder columns
temp
```


```{r results='asis', warning=FALSE, message=FALSE}
kable(temp, caption="Outcomes at 5 years") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

write.csv(temp, file = "data/data1.csv")
```


```{r}
# wroking dir = "C:/Users/Nick Lin/Desktop/Brophy_2020"
getwd()

# absolute path: "C:/Users/...../Brophy_2020/Figure1.rmd"
# relative path: "Figure1.rmd"
```


```{r}
temp2 <- read.csv("data/data1.csv")
temp2 <- read.csv("C:/Users/Nick Lin/Desktop/Brophy_2020/data/data1.csv")
temp2
```




## EXCEL data alone

### Primary outcome difference
Bayesian probability difference based on non-informative prior

```{r}
temp <- data.frame(Mc=Mc,Me=Me,Pc=Pc, Pe=Pe, Rc=Rc, Re=Re, Nc=Nc, Ne=Ne)
temp$Study <- c("PRECOMBAT", "NOBLE", "SYNTAX", "EXCEL")
temp <- temp[c(9,1:8)] # reorder columns
temp

# Excel data
Ex_p_c <- temp[4,4]
Ex_p_e <- temp[4,5]
Ex_n_c <- temp[4,8]
Ex_n_e <- temp[4,9]

paste0("Conirming that hot coded data ", (203/948) - (176/957), "is = to data read from file, ", (Ex_p_e/Ex_n_e) - (Ex_p_c/Ex_n_c))
```

### Paste çš„ç”¨æ³•

```{r}
paste("a", "b") # ä¹‹é–“æœƒå¤šç©ºæ ¼ï¼Œå› ç‚º sep = " "
paste0("a", "b") # ç­‰åŒæ–¼ paste("a", "b", sep = "")
paste("a", "b", sep = "/")
```


## Distribution in R 

### Four types of functions

- *d*ï¼šæ©Ÿï¥¡è³ªé‡/å¯†åº¦å‡½æ•¸ (mass / density)  
- *p*ï¼šï¥ç©æ©Ÿï¥¡å‡½æ•¸ (probability)  
- *q*ï¼šåï¥ç©æ©Ÿï¥¡å‡½æ•¸ (quantile)  
- *r*ï¼šæ ¹æ“šæŸæ©Ÿï¥¡åˆ†é…ï¼Œéš¨æ©Ÿ (random)ç”¢ç”Ÿä¹‹ï¥©å€¼ 

### Example 1: Normal Distribution

  * Ré è¨­æ˜¯$\mu=0,\sigma=1$çš„å¸¸æ…‹åˆ†é…ï¼Œå³æ¨™æº–å¸¸æ…‹åˆ†é… (standard normal distribution)
  1. `dnorm(x, mean = 0, sd = 1, log = F)`ï¼šè¨ˆç®—$f(x)=\frac{1}{\sigma\sqrt{2\pi}}e^{-\frac{(x-\mu)^2}{2\sigma^2}},x \in \mathbb{R}$
  2. `pnorm(x, mean = 0, sd = 1, lower.tail = T, log.p = F)`ï¼šè¨ˆç®—$F_X(x) =  \int_{-\infty}^x \frac{1}{\sigma\sqrt{2\pi}}e^{-\frac{(x-\mu)^2}{2\sigma^2}} dx$
  3. `qnorm(p, mean = 0, sd = 1, lower.tail = T, log.p = F)`ï¼šè¨ˆç®—$F_X^{-1}(x)$
  4. `rnorm(n, mean = 0, sd = 1)`ï¼šå¾*N*(`mean`, `sd`)éš¨æ©Ÿç”¢ç”Ÿ*n*ç­†è³‡æ–™

![](figure/normal_distribution.svg)
![](https://r-coder.com/wp-content/uploads/2020/10/dnorm-pnorm-qnorm-functions.png)

è‡ªå·±æª¢æŸ¥çœ‹çœ‹å§
```{r}
normal_sample <- rnorm(1000)
hist(normal_sample) # plot histogram

# If X ~ Normal(0, 1)ï¼Œ
dnorm(-1, mean = 0, sd = 1) # æ±‚ f(X = -1) åœ¨ X = -1 é€™é»çš„"æ©Ÿç‡å¯†åº¦"
pnorm(-1, mean = 0, sd = 1) # æ±‚ F(X = -1) = \int_{-infty}^{-1} f(X = -1) dx = Pr(X <= -1) æ±‚ X å°æ–¼ç­‰æ–¼ -1 çš„ç´¯ç¸¾æ©Ÿç‡
qnorm(0.1586553, mean = 0, sd = 1)
qnorm(pnrom(-1, mean = 0, sd = 1)) == -1 # TRUE, äº’ç‚ºåå‡½æ•¸


# é«˜ä¸­çµ±æ©Ÿå¸¸èªªçš„ä¸€å€‹æ¨™æº–å·®å…§ã€å…©å€‹æ¨™æº–å·®å…§ã€ä¸‰å€‹æ¨™æº–å·®å…§
prob_1sd <- pnorm(1) - pnorm(-1); prob_1sd
prob_2sd <- pnorm(2) - pnorm(-2); prob_2sd
prob_3sd <- pnorm(3) - pnorm(-3); prob_3sd
```

### Example2: Normal Distribution

1. `dbinom(x, n, Î¸, log = F)`ï¼šè¨ˆç®—$p(x)=C^n_xÎ¸^x(1-Î¸)^{n-x},x=0,1,...,n$  
2. `pbinom(x, n, Î¸, lower.tail = T, log.p = F)`ï¼šè¨ˆç®—$P(X \leq x)$  
3. `qbinom(p, n, Î¸, lower.tail = T, log.p = F)`ï¼šè¨ˆç®—$P(X \leq x)$çš„åå‡½æ•¸  
4. `rbinom(m, n, Î¸)`ï¼šå¾*Bin*(*n*, *Î¸*)éš¨æ©Ÿç”¢ç”Ÿ*m*ç­†è³‡æ–™

å…¶ä»– R å…§å»ºçš„å„ç¨®åˆ†é… `help(distribution)`


--------------------------------------------------------------------------------
## 0701_Exercises

0. è£œ 0628_Exercises

1. ç†è«–ä¸Šå° list ç”¨ `[` ä¸æœƒæ”¹è®Š list çš„å‹æ…‹ï¼Œè€Œä½¿ç”¨ `[[` æˆ– `$` å‰‡æœƒæ˜¯å– list è£¡çš„å…ƒç´ å‡ºä¾†ï¼Œå› æ­¤å‹æ…‹å¯èƒ½æœƒæ”¹è®Šã€‚æˆ‘å€‘èªªé data.frame æœ¬è³ªä¸Šæ˜¯ listï¼Œç„¶è€Œ data.frame å»æœ‰ä¸€å€‹å¥‡æ€ªçš„æ©Ÿåˆ¶ï¼Œè«‹ä½ æª¢æŸ¥

tidy data.frame
```{r}
temp
View(temp)

temp[1, 1] %>% typeof()
temp[, 1, drop = FALSE] # Notice!!
temp[, c(1, 3)] # Notice!!
temp[1, ]
temp[1]
temp["Study"]

temp[[1]]
temp[["Study"]]
temp$Study
```
  
  - åœ¨ `[`, `[[` å’Œ `$` ä¸­é‚£äº›çµæœæ˜¯æœƒä¿æŒ data.frame çš„å½¢å¼ï¼Œé‚£äº›ä¸æœƒ
  - æœ‰æ²’æœ‰ä»¤ä½ æ„Ÿåˆ°æ„å¤–çš„é¸é … (æŠ±æ­‰ï¼Œæˆ‘å‰›å‰›è‡ªå·±ä¸Šèª²æ™‚ä¹Ÿææ··äº†ï¼Œé€™æ˜¯ data.frame çš„ä¸€å€‹ç¼ºé»)  
  - è©¦è©¦çœ‹é€™å€‹ `temp[, 1, drop = FALSE]` èˆ‡ `temp[, 1]` ç›¸åŒå—ï¼Ÿ 
  - [é¡å¤–è£œå……ï¼šdata.frame vs. tibble](https://adv-r.hadley.nz/vectors-chap.html#tibble)
  
2. Distribution in R å°ç¯€ä¸­ä»‹ç´¹äº† ddist(), pdist(), qdist() èˆ‡ rdist() é€™å››é¡è·Ÿåˆ†é…æœ‰é—œçš„å‡½æ•¸
  
  - æˆ‘å¾Œä¾†æœ‰å¤šæ‰“ä¸€äº›ç­†è¨˜åœ¨ä¸Šé ­ï¼Œè«‹ä½ è‡ªå·±åŸ·è¡Œçœ‹çœ‹çµæœæ˜¯å¦ç¬¦åˆä½ çš„é æœŸ
  - è«‹ä½ è‡ªå·±ç·´ç¿’ä¸€ç¨®åˆ†é…ï¼Œä¸¦æ”¹æ”¹çœ‹ä¸åŒåƒæ•¸ä¸‹çš„çµæœè®ŠåŒ–

3. R åœ¨ç”Ÿç”¢è¡¨æ ¼ï¼Œç‰¹åˆ¥æ˜¯åœ¨ html æ–‡ä»¶æ™‚ï¼Œæœ‰å„å¼å„æ¨£å°ˆé–€çš„å¥—ä»¶å€‘

  - å¯ä»¥åƒè€ƒé€™ç¯‡æ–‡ç« ï¼š [How to Make Beautiful Tables in R](https://rfortherestofus.com/2019/11/how-to-make-beautiful-tables-in-r/)
  - å¦‚æœä½ æƒ³è¦ç”¢ç”Ÿ latex å’Œ pdf æ–‡ç« æ™‚ï¼Œæˆ‘æœƒå»ºè­°ä½¿ç”¨ kable + kableExtra é€™å…©å€‹å¥—ä»¶
  - å¦‚æœä½ æƒ³è¦ç”¢ç”Ÿ html æ–‡ç« ä¸¦å«æœ‰äº’å‹•å¼çš„è¡¨æ ¼ï¼Œæˆ‘æœƒå»ºè­°ä½¿ç”¨ DT å¥—ä»¶ï¼Œä¾‹å¦‚

```{r}
# install.packages("DT")
DT::datatable(iris)
```

4. data.frame å°æ–¼ R ä½¿ç”¨è€…ä¾†èªªæ˜¯ä¸€å€‹å¾ˆé‡è¦çš„è³‡æ–™æ ¼å¼ï¼Œä½†æˆ‘å€‘ä¸Šèª²çš„æ™‚é–“æœ‰é™ï¼Œæˆ‘ç„¡æ³•ä¸€ä¸€ä»‹ç´¹å“ªæœ‰å“ªäº›ç‰¹åˆ¥çš„èªæ³•ï¼Œæ‰€ä»¥è«‹ä½ åƒè€ƒä¸‹åˆ—æ–‡ç« ï¼Œå¦‚æœæœ‰ä¸æœƒçš„æˆ–çœ‹ä¸æ‡‚èªæ³•åœ¨è·Ÿæˆ‘èªª

  - [Create, Access, Modify and Delete Data Frame in R](https://www.datamentor.io/r-programming/data-frame/)
  - [R åˆ—è¡¨è®Šæ•¸èˆ‡ Data Frames](https://blog.gtwang.org/r/r-lists-and-data-frames/)

5. çµ•å°èˆ‡ç›¸å°è·¯å¾‘æ˜¯é›»è…¦æ‰¾å°‹æª”æ¡ˆæ™‚å¾ˆé‡è¦çš„æ¦‚å¿µï¼Œå› æ­¤ä¸é™æ–¼ R æœ¬èº«ï¼Œå¹¾ä¹æ¯å€‹ç¨‹å¼èªè¨€éƒ½æœƒç¢°åˆ°ã€‚ä½ å¯ä»¥æƒ³åƒçµ•å°è·¯å¾‘å°±æ˜¯åœ°å€ï¼Œä¾‹å¦‚å°å¤§çš„çµ•å°è·¯å¾‘ï¼šå°åŒ—å¸‚å¤§å®‰å€ç¾…æ–¯ç¦è·¯1è™Ÿï¼›è€Œç›¸å°è·¯å¾‘å‰‡æœƒæ˜¯èªªï¼Œå°å¤§åœ¨æˆ‘çš„å®¿èˆ(ç›®å‰å·¥ä½œç›®éŒ„)å³é‚Šå…©å€‹è¡—å€
  - è«‹ä½ çœ‹å®Œé€™éƒ¨å½±ç‰‡ [Absolute and Relative Paths](https://www.youtube.com/watch?v=ephId3mYu9o)
  - è«‹å• `.`, `..` å’Œ `~` åˆ†åˆ¥ä»£è¡¨ä»€éº¼æ„æ€
  - `getwd())` å’Œ `setwd())` åˆ†åˆ¥ä»£è¡¨ä»€éº¼æ„æ€ (è«‹æŸ¥ help)
  
6. é ç¿’ Doing Bayesian Data Analysis (Kruschke, 2014) Ch.6
--------------------------------------------------------------------------------



[é¡å¤–è£œå……]

tibble
```{r}
temp_tibble <- tibble(temp)
temp_tibble

temp_tibble[, 1]
temp_tibble[2, 2]
```
é€™ä¸€éƒ¨åˆ†ä¸‹æ¬¡å†èªª
```{r}
getwd()
setwd()
dir()
```

```{r}
sprintf()
```


â†“â†“â†“â†“â†“ é€™é‚Šé–‹å§‹ä½ æ‡‰è©²å¯ä»¥è‡ªè¨˜å…ˆçœ‹çœ‹ â†“â†“â†“â†“â†“

```{r}
set.seed(1234)
#Prior is beta(1,1)
# sampling 100,000 random variables from posterior
post_Ex_p_c <- rbeta(100000, Ex_p_c + 1, Ex_n_c - Ex_p_c + 1 )
post_Ex_p_e <- rbeta(100000, Ex_p_e + 1, Ex_n_e - Ex_p_e + 1 )
```

```{r}
# calculting posterior of differences
post_Ex_p_diff <- post_Ex_p_e - post_Ex_p_c
paste("EXCEL data alone - Differences in MACE between PCI & CABG")
quantile(post_Ex_p_diff, probs = c(0.025, .5, 0.975))
```


```{r}
bayestestR::hdi(post_Ex_p_diff)
```

```{r}
hist(post_Ex_p_diff) # ç•«ç›´æ–¹åœ–
plot(density(post_Ex_p_c)) # ç•«åˆ†é…å¯†åº¦åœ–
summary(post_Ex_p_c) # åŸºæœ¬çµ±è¨ˆ
```

```{r}
# probabilities >0 and >1
paste("EXCEL data alone - Probability PCI worse than CABG = ", sum(post_Ex_p_diff*100 >0)/100000)
paste("EXCEL data alone - Probability PCI worse than CABG by >1% = ", sum(post_Ex_p_diff*100 >1)/100000)


# given large sample sizes, can verify answers with normal approximation
paste("With normal approximation, EXCEL data alone - Probability PCI worse than CABG = ", round(1-pnorm(0, mean(post_Ex_p_diff*100), sd(post_Ex_p_diff*100)),3))
paste("With normal approximation, EXCEL data alone - Probability PCI worse than CABG > 1% = ", round(1-pnorm(1, mean(post_Ex_p_diff*100), sd(post_Ex_p_diff*100)),3))


Ex_diff_df <- data.frame(post_Ex_p_diff)
Ex_diff_df$post_Ex_p_diff <- Ex_diff_df$post_Ex_p_diff*100
```

â†‘â†‘â†‘â†‘â†‘ é€™é‚Šä»¥ä¸Šä½ æ‡‰è©²å¯ä»¥è‡ªå·±å…ˆçœ‹çœ‹ â†‘â†‘â†‘â†‘â†‘


--------------------------------------------------------------------------------
## 0706_Exercises

0. è£œçœ‹ 0701_Exercises ç¬¬ 5 é¡Œã€‚

1. å°‡ä¸Šæ–¹ code å¾—å…ˆè‡ªè¡Œçœ‹éä¸€éï¼Œå¯åƒè€ƒä»Šå¤©ä¸Šèª²çš„è¬›ç¾© (æˆ‘æŠŠæ‰‹å¯«ç­†è¨˜è¼¸å‡ºæˆ .pdf æ”¾åœ¨ note è³‡æ–™å¤¾ä¸­)ã€‚

2. å¦‚æœä½ æœ‰æ™‚é–“çš„è©±ï¼Œæˆ‘æœƒå»ºè­°ä½ æŠŠä¸‹é¢ä¸‰å€‹å½±ç‰‡çœ‹å®Œï¼Œä»–æ˜¯å‹•ç•«æ‰€ä»¥çœ‹èµ·ä¾†æœƒå¾ˆæœ‰fu~

- [Binomial distributions | Probabilities of probabilities, part 1](https://www.youtube.com/watch?v=8idr1WZ1A7Q&list=RDCMUCYO_jab_esuFRV4b17AJtAw&index=1)
- [Bayes theorem](https://www.youtube.com/watch?v=HZGCoVF3YvM&list=RDCMUCYO_jab_esuFRV4b17AJtAw&index=2) 
- [Why Bayes rule is nicer with odds](https://www.youtube.com/watch?v=lG4VkPoG3ko&list=RDCMUCYO_jab_esuFRV4b17AJtAw&index=4)

3. [é¡å¤–è£œå……] éƒ½ä¸å°å¿ƒè¬›åˆ° maximum likelihood estimationï¼Œå¯ä»¥åƒè€ƒé€™å€‹å½±ç‰‡ [StatQuest: Maximum Likelihood, clearly explained!!!](https://www.youtube.com/watch?v=XepXtl9YKwc)

--------------------------------------------------------------------------------

### Sprintf() vs. paste()

```{r}
paste0("Conirming that hot coded data ", (203/948) - (176/957), "is = to data read from file, ", (Ex_p_e/Ex_n_e) - (Ex_p_c/Ex_n_c))


sprintf("Conirming that hot coded data %.2f is = to data read from file, %.2f",
        (203/948) - (176/957), (Ex_p_e/Ex_n_e) - (Ex_p_c/Ex_n_c))

Name = "Nick"
Age = 25L
Height = 173.568234

sprintf("Name = %s, Age = %d, and Height = %.2f cm", Name, Age, Height)

sprintf("%f", pi)
sprintf("%.3f", pi)
sprintf("%1.0f", pi)
sprintf("%5.1f", pi)
sprintf("%05.1f", pi)
sprintf("%+f", pi)
sprintf("% f", pi)
sprintf("%-10f", pi) # left justified
sprintf("%e", pi)
sprintf("%E", pi)
sprintf("%g", pi)
sprintf("%g",   1e6 * pi) # -> exponential
sprintf("%.9g", 1e6 * pi) # -> "fixed"
sprintf("%G", 1e-6 * pi)

```


# ggplot2

åƒè€ƒè¬›ç¾©ï¼š

- ggplot > data_manipulation_and_plot_in_R-master > tidyverse_intro.html

- ggplot > useR-2021-ggplot2-tutorial-main > docs > index.html

```{r}
a <- 1:10
sum(sqrt(a))

a %>% 
  sqrt() %>% # ctrl(command)+shift+m 
  sum()

```

```{r}
# plot showing good normal approximation to binomial histogram
ggplot(Ex_diff_df, aes(x= post_Ex_p_diff)) + 
    geom_histogram(aes(y=..density..), bins=100, colour="black", fill="white")+
    geom_density(alpha=.2, fill="#FF6666") +
    scale_x_continuous(name = "Primary outcome difference (PCI - CABG)") +
    scale_y_continuous(name = "Density") +
    ggtitle("EXCEL Probability density for risk difference in  primary outcome\n (with superimposed Gaussian kernal density estimate )")+
    theme_minimal()

GGthemes
```
     
The calculated differrence in event ratios are based on the ratios of events to total populations in each arm. They do not include time to event as reported in the orginal NEJM publication and are consequentlty slightly different than the reported event rates.

### EXCEL Primary outcome graph
#### Figure 1a

```{r}
df <- data.frame(x = c(-3, 8))
df
ggplot(df, aes(x = x)) +
        stat_function(fun = dnorm, 
                      args = list(mean = mean(post_Ex_p_diff*100),
                                  sd = sd(post_Ex_p_diff*100)),
                      colour = "deeppink") +
        scale_x_continuous(name = "Primary outcome difference (PCI - CABG) -> PCI worse") +
        scale_y_continuous(name = "Density") +
        ggtitle("EXCEL Probability Density Function \n (primary outcome risk difference )") +
        geom_vline(xintercept=mean(post_Ex_p_diff*100)) +
        annotate("text", label = "Black vertical line = mean outcome \n difference (3.0%) increased with PCI", x = 5.5, y = .1, color = "black") +
        annotate("text", label = "Grey AUC = probability (87%) \n PCI > CABG outcome by > 1%", x = 0.5, y = .18, color = "black") +
         annotate("text", label = "Grey + yellow AUC = probability (95%) \n PCI > CABG outcome", x = 0, y = .1, color = "black") +
        theme_economist() +
        stat_function(fun = dnorm, 
                      args = list(mean(post_Ex_p_diff*100),
                                  sd(post_Ex_p_diff*100)), 
                      xlim = c(1,8), 
                      geom = "area", 
                      alpha = 0.2) +
        stat_function(fun = dnorm, 
                      args = list(mean(post_Ex_p_diff*100), sd(post_Ex_p_diff*100)), 
                      xlim = c(0,1), 
                      geom = "area", 
                      alpha = 0.2, 
                      fill = "yellow") 
fig1a
```


### EXCEL Mortality difference
Bayesian probability difference based on non-informative prior

```{r}
# Excel data
Ex_m_c <- temp[4,2]
Ex_m_e <- temp[4,3]
Ex_n_c <- temp[4,8]
Ex_n_e <- temp[4,9]

#Prior is beta(1,1)
# sampling 10,000 RV from posterior
post_Ex_m_c <- rbeta(10000, Ex_m_c + 1, Ex_n_c - Ex_m_c + 1 )
post_Ex_m_e <- rbeta(10000, Ex_m_e + 1, Ex_n_e - Ex_m_e + 1 )

# calculting posterior of differences
post_Ex_m_diff <- post_Ex_m_e - post_Ex_m_c
quantile(post_Ex_m_diff, probs = c(0.025, .5, 0.975))
bayetestR::hdi(post_Ex_m_diff)


1-pnorm(0, mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100))
1-pnorm(1, mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100))

```

#### EXCEL Total Mortality graph Figure 1b

```{r}
fig1b <- ggplot(data.frame(x = c(-2, 7.5)), aes(x = x)) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100)), colour = "deeppink") +
        scale_x_continuous(name = "Total mortality difference (PCI - CABG) -> PCI worse") +
        scale_y_continuous(name = "Density") +
        ggtitle("EXCEL Probability Density Function \n (total mortality risk difference)") +
        geom_vline(xintercept=mean(post_Ex_m_diff*100)) +
        annotate("text", label = "Black vertical line  = mean outcome \n difference (3.3%) increased with PCI", x = 5.5, y = .05, color = "black") +
        annotate("text", label = "Grey AUC = probability (94%) \n PCI > CABG outcome by > 1%", x = 0.5, y = .22, color = "black") +
         annotate("text", label = "Grey + yellow AUC = probability (99%) \n PCI > CABG outcome", x = 0, y = .1, color = "black") +
        theme_economist() +
        stat_function(fun = dnorm, args = list(mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100)), xlim = c(1,8), geom = "area", alpha = 0.2) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100)), xlim = c(0,1), geom = "area", alpha = 0.2, fill = "yellow") 
fig1b
```

### EXCEL MACCE outcome difference
Bayesian probability difference based on non-informative prior

```{r}
# Excel data
Ex_r_c <- temp[4,6]
Ex_r_e <- temp[4,7]
Ex_n_c <- temp[4,8]
Ex_n_e <- temp[4,9]

set.seed(1234)
#Prior is beta(1,1)
# sampling 100,000 RV from posterior
post_Ex_r_c <- rbeta(100000, Ex_r_c + 1, Ex_n_c - Ex_r_c + 1 )
post_Ex_r_e <- rbeta(100000, Ex_r_e + 1, Ex_n_e - Ex_r_e + 1 )

# calculting posterior of differences
post_Ex_r_diff <- post_Ex_r_e - post_Ex_r_c
paste("EXCEL data alone - Differences in MACCE between PCI & CABG")
quantile(post_Ex_r_diff, probs = c(0.025, .5, 0.975))

# probability > 0
sum(post_Ex_r_diff*100 >0)/100000
# probability > 3
sum(post_Ex_r_diff*100 >3)/100000

Ex_diff_df <- data.frame(post_Ex_r_diff)
Ex_diff_df$post_Ex_r_diff <- Ex_diff_df$post_Ex_r_diff*100


ggplot(Ex_diff_df, aes(x= post_Ex_r_diff)) + 
    geom_histogram(aes(y=..density..), bins=100, colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666") +
    scale_x_continuous(name = "Primary outcome difference (PCI - CABG)") +
    scale_y_continuous(name = "Density") +
    ggtitle("EXCEL Probability density for risk difference in  primary outcome\n (with superimposed Gaussian kernal density estimate )") +
    theme_economist()

```

### EXCEL Total MACCE graph
#### Figure 1c

```{r}
like <- temp[4,]
RD_re_like <- rma(ai=Re, n1i= Ne, ci=Rc, n2i=Nc, data=like, measure="RD",
           slab=paste(Study), method="REML")
forest(RD_re_like)
grid::grid.text("Forest plot risk differences (MACCE outcome)", .5, .8, gp=grid::gpar(cex=1))

fig1c <- ggplot(data.frame(x = c(0, 14)), aes(x = x)) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_r_diff*100), sd(post_Ex_r_diff*100)), colour = "deeppink") +
        scale_x_continuous(name = "Secondary composite outcome difference (PCI - CABG) -> PCI worse") +
        scale_y_continuous(name = "Density") +
        ggtitle("EXCEL Probability Density Function \n (Secondary composite outcome risk difference )") +
        geom_vline(xintercept=mean(post_Ex_r_diff*100)) +
        annotate("text", label = "Black vertical line  = mean outcome \n difference (6.7%) increased with PCI", x = 10, y = .05, color = "black") +
        annotate("text", label = "Grey AUC = probability (97%) \n PCI > CABG outcome by > 3%", x = 4, y = .16, color = "black") +
         annotate("text", label = "Grey + yellow AUC = probability (99.9%) \n PCI > CABG outcome", x = 3, y = .06, color = "black") +
        theme_economist() +
        stat_function(fun = dnorm, args = list(mean(post_Ex_r_diff*100), sd(post_Ex_r_diff*100)), xlim = c(3,14), geom = "area", alpha = 0.2) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_r_diff*100), sd(post_Ex_r_diff*100)), xlim = c(0,3), geom = "area", alpha = 0.2, fill = "yellow") 
fig1c

cat("Probability > 0 - 8 events\n")
for (i in 0:8){
    print(1-pnorm(i, mean(post_Ex_r_diff*100), sd(post_Ex_r_diff*100)))
}
```

## Combining graphs

```{r}
ggsave(fig1a, "fig1a.jpg")
pdf("fig1.pdf")
plot(fig1a)
plot(fig1b)
plot(fig1c)
dev.off()
```

