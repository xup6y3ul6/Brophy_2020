---
title: "Bayesian analysis of EXCEL results - Figure 1"
author: "J Brophy"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    highlight: tango
    theme: cerulean
    toc: yes
    toc_float: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Fundamental

## Version and setting

First for all
```{r}
sessionInfo()
```

è¨­ç½®æˆ UTF-8
- Tools > Global Options > Code > Saving > Default text encoding > UTF-8


## Rstudio environment

- Four panels
  + Script
  + Console
  + Environment, History, Connections, Tuttorial
  + Files, Plots, Packages, Help, Viewer
- R project
- Rmd
  + Reference: https://rmarkdown.rstudio.com/lesson-1.html
  + Knit
  + Code chunk: (Mac) command+option+i / (Win) ctrl+alt+i

## Data structure

Vector
- Atomic vector
  + Logical
  + Integer (factor, date) \in numeric(number)
  + Double (time) \in numeric(number)
  + Character
  + (vector, matrix, array)
- List (data.frame, tibble)

command+option+i / cntl+alt+i

### Atomic vector

#### logical/integer/double/character vector
```{r}
a = c(1L, 2L, 3L) #integer
a
typeof(a)
mode(a)

d = c(3.3, 3.14) # double
d
typeof(d) # vvvv
mode(d) # xxxx

b = c("ha", "you", "hello") #charcter
b
typeof(b)

e = c(TRUE, FALSE, T, F)
e
typeof(e)
```

#### matrix / array
```{r}

1:8
c(1, 2, 3, 4, 5,6,7,8)
aMatrix <- matrix(1:8, ncol = 2, byrow = TRUE)
aMatrix

aArray <- array(1:8, dim = c(2,2,2))
aArray
```


#### subvector
```{r}
d <- c(23, 2.5, 3.8, 9)
d
typeof(d)

sum(d)
sd(d)
max(d)
min(d)
summary(d)

d[2]
d[3]

d[c(1, 3)]

aMatrix[2, 1]
aMatrix[1, ]
aMatrix[, 1]
aMatrix[c(2,3), c(1,2)]
aMatrix[6]
aMatrix

```

### List

#### list
```{r}
l = list(3, 3.4, "a", TRUE)
l
typeof(l)

aList = list(a = 1:3, # a = c(1,2,3)
             b = TRUE, 
             c = list(d = "happy", 
                      e = c(1.3, 4.5, 7.83, pi)))
aList

typeof(aList)
class(aList)
```

#### sublist??
```{r}
aList
aList[1]
aList["a"]
aList$a
aList[[1]]
aList[["a"]]

aList$c
aList$c[2]
aList$c[[2]]
aList$c[2][2]
aList$c[[2]][2]
aList$c$e
aList$c$e[2]

aList[3]
aList[[3]]
aList[[3]][2]
#...
```

#### data.frame (2-dim)

- row: observation
- col: variable
```{r}
rep(1.5, times = 6)
rev(11:16)
aDf <- data.frame(a = rep(1.5, times = 6),
                  b = c("a", "b", "c", "d", "e", "f"),
                  c = LETTERS[1:6],
                  d = c(TRUE, FALSE, TRUE, FALSE, T, F),
                  e = rev(11:16))
aDf
typeof(aDf)
class(aDf)
class(aList)


```
#### sub-data.frame
```{r}
# [] 
aDf[1]
aDf["a"]

# [,]
aDf[1, 3]
aDf[c(1, 3), 3:4]

# [[]]
aDf[[3]]
aDf[["c"]]
aDf[[3]][3]

# $
aDf$e
aDf$e[2:3]
```

## How to use help

```{r}
d
sum(d)
help(sum)
?sum
??sum
```



--------------------------------------------------------------------------------
## 0628_Exercise

1. å¦‚æžœæœ‰ç©ºçš„è©±å¯ä»¥çœ‹ä¸€çœ‹ Rmarkdown çš„ä»‹ç´¹ [https://rmarkdown.rstudio.com/lesson-1.html]ï¼Œæˆ–æ˜¯ç›´æŽ¥ä¸Šç¶²æœå°‹ Rmarkdown çš„å…¶ä»–æ•™å­¸ã€‚
  
  - ä½ å¯ä»¥å˜—è©¦ knit é€™ä»½æ–‡ä»¶çœ‹çœ‹ï¼Ÿï¼æ˜¯å¦æœ‰æˆåŠŸï¼Ÿ

2. ç†è§£ä¸Šæ–¹æ¯ä¸€æ¢ code çš„èªžæ³•èˆ‡çµæžœæ˜¯ä»€éº¼
  
  - å¯ä»¥å˜—è©¦æ›´æ”¹è£¡é ­çš„å…ƒç´ ï¼Œå¦‚`[1]`æ”¹æˆ`[2]`
  - ç”¨ `help()` æŸ¥è©¢æ¯å€‹ function, å¦‚ `help(c)`, `help(sum)`, `help(help)`
  - ä½ èƒ½ä¸èƒ½å»ºç«‹å±¬æ–¼è‡ªå·±çš„ä¾‹å­
  
3. è§€å¯Ÿ atomic vector èˆ‡ list è®Šæ•¸è·‘å‡ºä¾†å‘ˆç¾ä¸Šçš„å·®ç•°ã€‚

4. åœ¨ sub-list èˆ‡ sub-data.frame çš„ code chunk ä¸­ï¼Œåˆ†åˆ¥ç”¨äº† `[`ã€`[[`é‚„æœ‰ 
`$` é€™ä¸‰ç¨®å¥‡æ€ªçš„ç¬¦è™Ÿ
  
  - è«‹ä½ ä»”ç´°è§€å¯Ÿé€™ä¸‰å€‹ç¬¦è™Ÿä½¿ç”¨ä¸Šçš„å·®ç•°ï¼Œä¸¦åœ¨ä¸‹æ¬¡ä¸Šèª²æ™‚å‘Šæ•¸æˆ‘ä½ ç™¼ç¾åˆ°ä»€éº¼ã€‚
  - å»ºè­°å¯ä»¥æ­é… `typeof()` è§€å¯Ÿï¼Œä¾‹å¦‚ `typeof(aList[[3]])`ã€‚
 
5. [é¡å¤–è£œå……] [è¼•é¬†å­¸ç¿’Rèªžè¨€](https://yaojenkuo.gitbooks.io/learn-r-the-easy-way/content/chapter2.html)ï¼Œå¯ä»¥åƒè€ƒè£¡é ­çš„ Day2-Day7
  
  - é€™å¹¾ç« å‰›å¥½æœ‰æåˆ° R å…¶ä»–ç¨®é¡žçš„è³‡æ–™åž‹æ…‹ (type of) ä»¥åŠè³‡æ–™çµæ§‹ (structure) æˆ–æ­£ç¢ºä¾†èªªæ˜¯å±¬æ€§ (class)
  - é›–ç„¶ä»–æ˜¯å¯«å¾—æ·ºé¡¯æ˜“æ‡‚ (è€Œä¸”æ˜¯ä¸­æ–‡)ï¼Œä½†å¯¦éš›ä¸Šä»–å°‡è³‡æ–™çµæ§‹ç”¨ç¶­åº¦çš„æ–¹å¼ä¾†é€²è¡Œåˆ†é¡žï¼Œæˆ‘èªç‚ºéžå¸¸ä¸æ°ç•¶ä¹Ÿä¸åŒæ„ä»–çš„èªªæ³•ï¼Œå› ç‚ºå®ƒä¸¦æ²’æœ‰æŠŠ atomic vector èˆ‡ list åšå‡ºæ˜Žé¡¯çš„å€åˆ†ã€‚
  - æœ€æ­£ç¢ºçš„åˆ†é¡žæ–¹å¼ï¼š[Advance R: Chapter 3](https://adv-r.hadley.nz/vectors-chap.html)
  - é †å¸¶ä¸€æ,ä¸Šé¢å…©æœ¬æ›¸å¯¦éš›ä¸Šéƒ½æ˜¯è¦ Rmarkdown å¯«çš„å–”ï¼ï¼ï¼
  
6. å¦‚æžœä½ è¦ºå¾—æˆ‘ä¸Šèª²æœ‰ä»»ä½•å»ºè­°ï¼Œè¬›å¤ªç°¡å–®ã€å¤ªé›£ã€å¤ªæ…¢ã€å¤ªå¿«ç­‰ï¼Œéƒ½å¾ˆæ­¡è¿Žç•™è¨€å‘Šè¨´æˆ‘ï¼Œæˆ‘å€‘å¯ä»¥æŒçºŒæ”¹é€²æ‰¾åˆ°å½¼æ­¤é©åˆçš„æ¨¡å¼ ðŸ˜
--------------------------------------------------------------------------------




## Enter data

Enter data according to these variable names   
  
Mc = totality mortality in control (CABG) arm    
Me = totality mortality in experimental (PCI) arm    
Pc = Death, MI, stroke  in control (CABG) arm     
Pe = Death, MI, stroke in experimental (PCI) arm     
Re = MACCE outcome in experimental (PCI) arm (Death, MI, stroke, revascularization)         
Rc = MACCE outcome in control (CABG) arm (Death, MI, stroke, revascularization)          
Nc = Number of subjects in control (CABG) arm    
Ne = Number of subjects in experimental (PCI) arm     

$$
posterior = \frac{prior \times likelihood}{constant} \\
\sum_{i = 1}^n i = \frac{n\times(n+1)}{2}
$$

```{r results='asis', warning=FALSE, message=FALSE}
library(knitr)
library(coda)
library(rjags)
library(kableExtra)
library(ggplot2)
library(ggthemes)
library(metafor)
library(meta)
library(tidyverse)

# mortality data entered as NOBLE, SYNTAX,  EXCEL, PRECOMBAT (leave oout these small trials Boudriot) 
# composite endpoint for Noble = sum mortality+Mi+stroke PCI= 54+43+21=118; CABG=50+15+12=77
Mc<-c(23, 50, 48, 89) #event in non-expose (CABG)
Nc<-c(300, 592, 348, 957) #total in non-expose
Me<-c(17, 54, 45, 119) #event in expose (PCI)
Ne<-c(300, 592, 357, 948) #total in expose
Pc<-c(28, 77, 69, 176) #event in non-expose (CABG)
Pe<-c(25, 118, 67, 203) #event in expose (PCI)
Re <- c(52, 165,130,290) #event in expose (PCI) - MACCE includes revasc
Rc <- c(42, 110, 103, 228) #event in non-expose (CABG) - MACCE includes revasc


temp <- data.frame(Mc=Mc,Me=Me,Pc=Pc, Pe=Pe, Rc=Rc, Re=Re, Nc=Nc, Ne=Ne)
temp$Study <- c("PRECOMBAT", "NOBLE", "SYNTAX", "EXCEL")
temp <- temp[c(9,1:8)] # reorder columns

kable(temp, caption="Outcomes at 5 years") %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

 write.csv(temp, file = "data1.csv", row.names = FALSE)

```

## EXCEL data alone

### Primary outcome difference
Bayesian probability difference based on non-informative prior

```{r}
# Excel data
Ex_p_c <- temp[4,4]
Ex_p_e <- temp[4,5]
Ex_n_c <- temp[4,8]
Ex_n_e <- temp[4,9]

paste("Conirming that hot coded data ", (203/948) - (176/957), "is = to data read from file, ", (Ex_p_e/Ex_n_e) - (Ex_p_c/Ex_n_c))

set.seed(1234)
#Prior is beta(1,1)
# sampling 100,000 random variables from posterior
post_Ex_p_c <- rbeta(100000, Ex_p_c + 1, Ex_n_c - Ex_p_c + 1 )
post_Ex_p_e <- rbeta(100000, Ex_p_e + 1, Ex_n_e - Ex_p_e + 1 )

# calculting posterior of differences
post_Ex_p_diff <- post_Ex_p_e - post_Ex_p_c
paste("EXCEL data alone - Differences in MACE between PCI & CABG")
quantile(post_Ex_p_diff, probs = c(0.025, .5, 0.975))

# probabilities >0 and >1
paste("EXCEL data alone - Probability PCI worse than CABG = ", sum(post_Ex_p_diff*100 >0)/100000)
paste("EXCEL data alone - Probability PCI worse than CABG by >1% = ", sum(post_Ex_p_diff*100 >1)/100000)


# given large sample sizes, can verify answers with normal approximation
paste("With normal approximation, EXCEL data alone - Probability PCI worse than CABG = ", round(1-pnorm(0, mean(post_Ex_p_diff*100), sd(post_Ex_p_diff*100)),3))
paste("With normal approximation, EXCEL data alone - Probability PCI worse than CABG > 1% = ", round(1-pnorm(1, mean(post_Ex_p_diff*100), sd(post_Ex_p_diff*100)),3))


Ex_diff_df <- data.frame(post_Ex_p_diff)
Ex_diff_df$post_Ex_p_diff <- Ex_diff_df$post_Ex_p_diff*100

# plot showing good normal approximation to binomial histogram
ggplot(Ex_diff_df, aes(x= post_Ex_p_diff)) + 
    geom_histogram(aes(y=..density..), bins=100, colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666") +
    scale_x_continuous(name = "Primary outcome difference (PCI - CABG)") +
    scale_y_continuous(name = "Density") +
    ggtitle("EXCEL Probability density for risk difference in  primary outcome\n (with superimposed Gaussian kernal density estimate )") +
    theme_economist()


```
     
The calculated differrence in event ratios are based on the ratios of events to total populations in each arm. They do not include time to event as reported in the orginal NEJM publication and are consequentlty slightly different than the reported event rates.

### EXCEL Primary outcome graph
#### Figure 1a

```{r}
fig1a <- ggplot(data.frame(x = c(-3, 8)), aes(x = x)) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_p_diff*100), sd(post_Ex_p_diff*100)), colour = "deeppink") +
        scale_x_continuous(name = "Primary outcome difference (PCI - CABG) -> PCI worse") +
        scale_y_continuous(name = "Density") +
        ggtitle("EXCEL Probability Density Function \n (primary outcome risk difference )") +
        geom_vline(xintercept=mean(post_Ex_p_diff*100)) +
        annotate("text", label = "Black vertical line = mean outcome \n difference (3.0%) increased with PCI", x = 5.5, y = .1, color = "black") +
        annotate("text", label = "Grey AUC = probability (87%) \n PCI > CABG outcome by > 1%", x = 0.5, y = .18, color = "black") +
         annotate("text", label = "Grey + yellow AUC = probability (95%) \n PCI > CABG outcome", x = 0, y = .1, color = "black") +
        theme_economist() +
        stat_function(fun = dnorm, args = list(mean(post_Ex_p_diff*100), sd(post_Ex_p_diff*100)), xlim = c(1,8), geom = "area", alpha = 0.2) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_p_diff*100), sd(post_Ex_p_diff*100)), xlim = c(0,1), geom = "area", alpha = 0.2, fill = "yellow") 
fig1a
```


### EXCEL Mortality difference
Bayesian probability difference based on non-informative prior

```{r}
# Excel data
Ex_m_c <- temp[4,2]
Ex_m_e <- temp[4,3]
Ex_n_c <- temp[4,8]
Ex_n_e <- temp[4,9]

#Prior is beta(1,1)
# sampling 10,000 RV from posterior
post_Ex_m_c <- rbeta(10000, Ex_m_c + 1, Ex_n_c - Ex_m_c + 1 )
post_Ex_m_e <- rbeta(10000, Ex_m_e + 1, Ex_n_e - Ex_m_e + 1 )

# calculting posterior of differences
post_Ex_m_diff <- post_Ex_m_e - post_Ex_m_c
quantile(post_Ex_m_diff, probs = c(0.025, .5, 0.975))

1-pnorm(0, mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100))
1-pnorm(1, mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100))

```

#### EXCEL Total Mortality graph Figure 1b

```{r}
fig1b <- ggplot(data.frame(x = c(-2, 7.5)), aes(x = x)) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100)), colour = "deeppink") +
        scale_x_continuous(name = "Total mortality difference (PCI - CABG) -> PCI worse") +
        scale_y_continuous(name = "Density") +
        ggtitle("EXCEL Probability Density Function \n (total mortality risk difference)") +
        geom_vline(xintercept=mean(post_Ex_m_diff*100)) +
        annotate("text", label = "Black vertical line  = mean outcome \n difference (3.3%) increased with PCI", x = 5.5, y = .05, color = "black") +
        annotate("text", label = "Grey AUC = probability (94%) \n PCI > CABG outcome by > 1%", x = 0.5, y = .22, color = "black") +
         annotate("text", label = "Grey + yellow AUC = probability (99%) \n PCI > CABG outcome", x = 0, y = .1, color = "black") +
        theme_economist() +
        stat_function(fun = dnorm, args = list(mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100)), xlim = c(1,8), geom = "area", alpha = 0.2) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_m_diff*100), sd(post_Ex_m_diff*100)), xlim = c(0,1), geom = "area", alpha = 0.2, fill = "yellow") 
fig1b
```

### EXCEL MACCE outcome difference
Bayesian probability difference based on non-informative prior

```{r}
# Excel data
Ex_r_c <- temp[4,6]
Ex_r_e <- temp[4,7]
Ex_n_c <- temp[4,8]
Ex_n_e <- temp[4,9]

set.seed(1234)
#Prior is beta(1,1)
# sampling 100,000 RV from posterior
post_Ex_r_c <- rbeta(100000, Ex_r_c + 1, Ex_n_c - Ex_r_c + 1 )
post_Ex_r_e <- rbeta(100000, Ex_r_e + 1, Ex_n_e - Ex_r_e + 1 )

# calculting posterior of differences
post_Ex_r_diff <- post_Ex_r_e - post_Ex_r_c
paste("EXCEL data alone - Differences in MACCE between PCI & CABG")
quantile(post_Ex_r_diff, probs = c(0.025, .5, 0.975))

# probability > 0
sum(post_Ex_r_diff*100 >0)/100000
# probability > 3
sum(post_Ex_r_diff*100 >3)/100000

Ex_diff_df <- data.frame(post_Ex_r_diff)
Ex_diff_df$post_Ex_r_diff <- Ex_diff_df$post_Ex_r_diff*100


ggplot(Ex_diff_df, aes(x= post_Ex_r_diff)) + 
    geom_histogram(aes(y=..density..), bins=100, colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666") +
    scale_x_continuous(name = "Primary outcome difference (PCI - CABG)") +
    scale_y_continuous(name = "Density") +
    ggtitle("EXCEL Probability density for risk difference in  primary outcome\n (with superimposed Gaussian kernal density estimate )") +
    theme_economist()

```

### EXCEL Total MACCE graph
#### Figure 1c

```{r}
like <- temp[4,]
RD_re_like <- rma(ai=Re, n1i= Ne, ci=Rc, n2i=Nc, data=like, measure="RD",
           slab=paste(Study), method="REML")
forest(RD_re_like)
grid::grid.text("Forest plot risk differences (MACCE outcome)", .5, .8, gp=grid::gpar(cex=1))

fig1c <- ggplot(data.frame(x = c(0, 14)), aes(x = x)) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_r_diff*100), sd(post_Ex_r_diff*100)), colour = "deeppink") +
        scale_x_continuous(name = "Secondary composite outcome difference (PCI - CABG) -> PCI worse") +
        scale_y_continuous(name = "Density") +
        ggtitle("EXCEL Probability Density Function \n (Secondary composite outcome risk difference )") +
        geom_vline(xintercept=mean(post_Ex_r_diff*100)) +
        annotate("text", label = "Black vertical line  = mean outcome \n difference (6.7%) increased with PCI", x = 10, y = .05, color = "black") +
        annotate("text", label = "Grey AUC = probability (97%) \n PCI > CABG outcome by > 3%", x = 4, y = .16, color = "black") +
         annotate("text", label = "Grey + yellow AUC = probability (99.9%) \n PCI > CABG outcome", x = 3, y = .06, color = "black") +
        theme_economist() +
        stat_function(fun = dnorm, args = list(mean(post_Ex_r_diff*100), sd(post_Ex_r_diff*100)), xlim = c(3,14), geom = "area", alpha = 0.2) +
        stat_function(fun = dnorm, args = list(mean(post_Ex_r_diff*100), sd(post_Ex_r_diff*100)), xlim = c(0,3), geom = "area", alpha = 0.2, fill = "yellow") 
fig1c

cat("Probability > 0 - 8 events\n")
for (i in 0:8){
    print(1-pnorm(i, mean(post_Ex_r_diff*100), sd(post_Ex_r_diff*100)))
}
```

## Combining graphs

```{r}

pdf("fig1.pdf")
plot(fig1a)
plot(fig1b)
plot(fig1c)
dev.off()
```

